<template>
  <v-app-bar app floating elevation="2" :class="{ 'mt-2': true, scrolled: isScrolled }" color="transparent">
    <div class="d-flex align-center">
      <v-app-bar-title class="font-weight-bold text-white clickable-title" @click="goToDashboard"> WMTHIS </v-app-bar-title>
    </div>

    <div class="d-none d-md-flex">
      <!-- ÎåÄÏãúÎ≥¥Îìú Î©îÎâ¥ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu first-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ÎåÄÏãúÎ≥¥Îìú' }"
            v-bind="props"
            @click="goToDashboard"
          >
            ÎåÄÏãúÎ≥¥Îìú
          </v-btn>
        </template>
      </v-menu>

      <!-- Î©îÎâ¥ Í¥ÄÎ¶¨ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'Î©îÎâ¥ Í¥ÄÎ¶¨' }"
            v-bind="props"
            @click="setActiveMenu('Î©îÎâ¥ Í¥ÄÎ¶¨')"
          >
            Î©îÎâ¥ Í¥ÄÎ¶¨
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['Î©îÎâ¥ Í¥ÄÎ¶¨', 'Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨', 'ÏòµÏÖò Í¥ÄÎ¶¨']"
            :key="index"
            @click="setActiveDropdown('Î©îÎâ¥ Í¥ÄÎ¶¨', item)"
            :class="{ 'active-dropdown': activeDropdowns['Î©îÎâ¥ Í¥ÄÎ¶¨'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- Ïû¨Í≥† Í¥ÄÎ¶¨ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'Ïû¨Í≥† Í¥ÄÎ¶¨' }"
            v-bind="props"
            @click="setActiveMenu('Ïû¨Í≥† Í¥ÄÎ¶¨')"
          >
            Ïû¨Í≥† Í¥ÄÎ¶¨
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['Ïû¨Í≥† Ï†ïÎ≥¥', 'Ïû¨Í≥† ÏûÖÍ≥†']"
            :key="index"
            @click="setActiveDropdown('Ïû¨Í≥† Í¥ÄÎ¶¨', item)"
            :class="{ 'active-dropdown': activeDropdowns['Ïû¨Í≥† Í¥ÄÎ¶¨'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- Í∞ÄÍ≤å Î∂ÑÏÑù -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'Í∞ÄÍ≤å Î∂ÑÏÑù' }"
            v-bind="props"
            @click="setActiveMenu('Í∞ÄÍ≤å Î∂ÑÏÑù')"
          >
            Í∞ÄÍ≤å Î∂ÑÏÑù
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['Îß§Ï∂ú Î∂ÑÏÑù', 'Î©îÎâ¥ Î∂ÑÏÑù', 'Ïû¨Í≥† Î∂ÑÏÑù']"
            :key="index"
            @click="setActiveDropdown('Í∞ÄÍ≤å Î∂ÑÏÑù', item)"
            :class="{ 'active-dropdown': activeDropdowns['Í∞ÄÍ≤å Î∂ÑÏÑù'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- Ïª§ÎÆ§ÎãàÌã∞ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'Ïª§ÎÆ§ÎãàÌã∞' }"
            v-bind="props"
            @click="setActiveMenu('Ïª§ÎÆ§ÎãàÌã∞')"
          >
            Ïª§ÎÆ§ÎãàÌã∞
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['ÏßÄÎèÑÎ°ú Î≥¥Í∏∞', 'Î™©Î°ùÏúºÎ°ú Ï∞æÍ∏∞', 'Í±∞ÎûòÎÇ¥Ïó≠']"
            :key="index"
            @click="setActiveDropdown('Ïª§ÎÆ§ÎãàÌã∞', item)"
            :class="{ 'active-dropdown': activeDropdowns['Ïª§ÎÆ§ÎãàÌã∞'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- Í∞ÄÍ≤å Í¥ÄÎ¶¨ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'Í∞ÄÍ≤å Í¥ÄÎ¶¨' }"
            v-bind="props"
            @click="setActiveMenu('Í∞ÄÍ≤å Í¥ÄÎ¶¨')"
          >
            Í∞ÄÍ≤å Í¥ÄÎ¶¨
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['MY Page', 'POS']"
            :key="index"
            @click="setActiveDropdown('Í∞ÄÍ≤å Í¥ÄÎ¶¨', item)"
            :class="{ 'active-dropdown': activeDropdowns['Í∞ÄÍ≤å Í¥ÄÎ¶¨'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </div>

    <v-spacer></v-spacer>
    <!--
    <v-btn icon class="text-white custom-icon-btn">
      <v-icon>mdi-bell</v-icon>
    </v-btn>
    -->
    <v-menu v-model="showNotificationMenu" :close-on-content-click="false" offset-y>
      <template v-slot:activator="{ props }">
        <v-btn icon class="text-white custom-icon-btn" v-bind="props" @click="toggleMenuIfHasNotifications">
          <v-icon :key="hasUnreadNotification">
            {{ hasUnreadNotification ? "mdi-bell-alert" : "mdi-bell" }}
          </v-icon>
        </v-btn>
      </template>

      <v-list class="notification-list">
        <v-list-item v-if="notifications.length > 0 || !mariadbNotification.value" class="notification-item" @click="goToTransactions()">
          <v-list-item-title>Í±∞Îûò ÏöîÏ≤≠Ïù¥ ÏôîÏäµÎãàÎã§</v-list-item-title>
        </v-list-item>
      </v-list>
    </v-menu>

    <v-menu open-on-click offset-y>
      <template v-slot:activator="{ props }">
        <v-btn icon class="text-white custom-icon-btn" v-bind="props">
          <v-icon>mdi-dots-vertical</v-icon>
        </v-btn>
      </template>
      <v-list class="dropdown-list">
        <v-list-item @click="logout">
          <v-list-item-title>Î°úÍ∑∏ÏïÑÏõÉ</v-list-item-title>
        </v-list-item>
      </v-list>
    </v-menu>
  </v-app-bar>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, reactive, computed } from "vue";
import { useRouter } from "vue-router";
import { api } from "@/api/index.js";
import { marketApi } from "../../api/MarketApi";

const router = useRouter();

const isScrolled = ref(false);
const activeMenu = ref("");
const activeDropdowns = reactive({});

const handleScroll = () => {
  if (window.scrollY > 10) {
    isScrolled.value = true;
  } else {
    isScrolled.value = false;
  }
};

const setActiveMenu = (menu) => {
  activeMenu.value = menu;
};

const logout = async () => {
  try {
    await api.getLogout();
    alert("Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.");
    router.push({ name: "login" });
  } catch (error) {
    console.error("Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®:", error);
  }
};

const goToDashboard = () => {
  router.push({ name: "dashboard" });
};

const menuRoutes = {
  "Î©îÎâ¥ Í¥ÄÎ¶¨": {
    "Î©îÎâ¥ Í¥ÄÎ¶¨": "MenuMain",
    "Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨": "MenuCategory",
    "ÏòµÏÖò Í¥ÄÎ¶¨": "MenuOption",
  },
  "Ïû¨Í≥† Í¥ÄÎ¶¨": {
    "Ïû¨Í≥† Ï†ïÎ≥¥": "InventoryMain",
    "Ïû¨Í≥† ÏûÖÍ≥†": "InventoryRegister",
  },
  "Í∞ÄÍ≤å Î∂ÑÏÑù": {
    "Îß§Ï∂ú Î∂ÑÏÑù": "SalesAnalysis",
    "Î©îÎâ¥ Î∂ÑÏÑù": "MenuAnalysis",
    "Ïû¨Í≥† Î∂ÑÏÑù": "InventoryAnalysis",
  },
  Ïª§ÎÆ§ÎãàÌã∞: {
    "ÏßÄÎèÑÎ°ú Î≥¥Í∏∞": "CommunityMap",
    "Î™©Î°ùÏúºÎ°ú Ï∞æÍ∏∞": "CommunityList",
    Í±∞ÎûòÎÇ¥Ïó≠: "CommunityTransactions",
  },
  "Í∞ÄÍ≤å Í¥ÄÎ¶¨": {
    "MY Page": "MyPage",
    POS: "POSMain",
  },
};

const setActiveDropdown = (menu, item) => {
  activeDropdowns[menu] = item;
  activeMenu.value = menu;

  const routeName = menuRoutes[menu]?.[item];
  if (routeName) {
    router.push({ name: routeName });
  }
};

const showNotificationMenu = ref(false);
const notifications = ref([]); // WebSocketÏúºÎ°ú Î∞õÏùÄ Î©îÏãúÏßÄÎì§
let socket;
const mariadbNotification = ref(true); // ÏïàÏùΩÏùÄ ÏïåÎ¶ºÏù¥ ÏûàÏúºÎ©¥ false

function toggleMenuIfHasNotifications() {
  showNotificationMenu.value = hasUnreadNotification.value;
}

function goToTransactions() {
  // 1. ÏïåÎ¶º Î™©Î°ù Ï¥àÍ∏∞Ìôî
  notifications.value = [];

  // 2. ÏïåÎ¶ºÏ∞Ω Îã´Í∏∞
  showNotificationMenu.value = false;

  // 3. mariadbNotification ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
  mariadbNotification.value = false;

  // 4. ÏïåÎ¶º ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏöîÏ≤≠ (DBÏóê ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨)
  postNotification();

  // 5. Í±∞Îûò ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  router.push("/transactions");
}

async function getNotification() {
  try {
    const data = await marketApi.getNotification();
    console.log(data);
    if (data !== 404) {
      mariadbNotification.value = data.data;
    } else {
      console.error("ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
    }
  } catch (error) {
    console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
  }
}

async function postNotification() {
  try {
    const data = await marketApi.postNotification();
    console.log(data);
    if (data !== 404) {
      mariadbNotification.value = data.data;
    } else {
      console.error("ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
    }
  } catch (error) {
    console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
  }
}

const hasUnreadNotification = computed(() => {
  console.log("üîî notifications.length =", notifications.value.length);
  console.log("üîî mariadbNotification =", mariadbNotification.value);
  return notifications.value.length > 0 || !mariadbNotification.value;
});

onMounted(() => {
  window.addEventListener("scroll", handleScroll);
  getNotification();
  const socket = new WebSocket("ws://localhost:8080/ws");

  socket.onopen = () => {
    console.log("‚úÖ WebSocket Ïó∞Í≤∞Îê®");
  };

  socket.onmessage = (event) => {
    notifications.value.push(event.data);
  };

  socket.onerror = (error) => {
    console.error("‚ùå WebSocket Ïò§Î•ò:", error);
  };

  socket.onclose = () => {
    console.log("üîå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£åÎê®");
  };
});

onBeforeUnmount(() => {
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.close();
  }
  window.removeEventListener("scroll", handleScroll);
});
</script>

<style scoped>
.v-app-bar {
  display: flex !important;
  position: relative !important;
  max-width: 1300px;
  border-radius: 8px;
  background-color: #708090 !important;
}

.scrolled {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.header-menu {
  font-size: 16px;
  color: #292626 !important;
  transition: color 0.3s ease;
  margin-left: 30px !important;
  font-weight: bold !important;
}

.first-menu {
  margin-left: 50px !important;
}

/* Ìò∏Î≤Ñ Î∞è ÌÅ¥Î¶≠ Ìö®Í≥º Ï†úÍ±∞ */
.custom-btn::before {
  display: none !important;
}

.custom-btn::after {
  display: none !important;
}

.custom-btn:hover {
  background-color: transparent !important;
}

.custom-btn:active {
  background-color: transparent !important;
}

.custom-icon-btn::before {
  display: none !important;
}

.custom-icon-btn::after {
  display: none !important;
}

/* ÎìúÎ°≠Îã§Ïö¥ Ïä§ÌÉÄÏùºÎßÅ */
.dropdown-list {
  background-color: #708090 !important;
  border-radius: 8px;
  margin-top: 5px;
  padding: 0;
}

.v-list-item {
  min-height: 40px;
}

.v-list-item__title {
  color: #292626 !important;
  font-weight: bold;
}

.v-list-item:hover {
  background-color: rgba(255, 255, 255, 0.1) !important;
}

/* ÌôúÏÑ±ÌôîÎêú Î©îÎâ¥ Ïä§ÌÉÄÏùº */
.active-menu {
  color: white !important;
}

/* ÌôúÏÑ±ÌôîÎêú ÎìúÎ°≠Îã§Ïö¥ ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº */
.active-dropdown .v-list-item__title {
  color: white !important;
}

.clickable-title {
  margin-left: 20px;
  cursor: pointer;
}

.logout-dropdown-list {
  background-color: #708090 !important;
  border-radius: 8px;
  margin-top: 5px;
  padding: 0;
}

.notification-list {
  max-width: 300px;
  padding: 0;
  background-color: #708090 !important;
  border-radius: 8px;
}

.notification-item {
  border-bottom: 1px solid #eee;
  padding: 8px 16px;
}

.notification-item:last-child {
  border-bottom: none;
}
</style>
